---
title: "R Notebook"
output: html_notebook
---

## 1. Biomass analysis

```{r}
library(tidyr)
library (dplyr)
library (ggplot2)
library(agricolae)
library(knitr)
library(lubridate)
library(GGally)
```


# read and check
```{r}
info_raw <- read.csv("C:\\GitHubRepos\\Arbitrator\\Analysis\\Biomass_N_merged_WheatMaize.csv")
info_raw$X <- NULL

summary(info_raw)

```

# check formays
```{r}
info_work <- info_raw %>%
  mutate(HarvestDate = ymd(HarvestDate)) %>%
  mutate(Plot = factor(Plot)) %>%
  mutate(Block = factor(Block)) %>%
  mutate(NitroTreat = factor(NitroTreat, levels = c("Low N","Median N","High N"))) %>%
  mutate(WaterTreat = factor(WaterTreat, levels = c("Dryland","Irrigated")))

str(info_work)
```



```{r, fig.width=12, fig.height=8}
df_bio <- info_work %>% 
  dplyr::select(HarvestDate, Crop, Organ, NitroTreat, WaterTreat, Block,BiomassWeight) %>%
  tidyr::spread(Organ,BiomassWeight) %>%
  rowwise() %>%
  mutate(TotalBiomass = sum(Grain,Leaf,Rachis,Senesced,Stem, na.rm=TRUE)) %>%
  dplyr::select(-(Grain:Stem)) %>%  
  group_by(HarvestDate, Crop, NitroTreat, WaterTreat) %>%
  summarise(bio_mean = mean(TotalBiomass/1000),bio_sd = sd(TotalBiomass/1000))

```

## Nitrogen uptake

```{r, fig.width=12, fig.height=8}
df_n <- info_work %>% 
  dplyr::select(HarvestDate, Crop, Organ, NitroTreat, WaterTreat, Block,NitrogenWeight) %>%
  tidyr::spread(Organ,NitrogenWeight) %>%
  rowwise() %>%
  mutate(N_uptake = sum(Grain,Leaf,Rachis,Senesced,Stem, na.rm=TRUE)) %>%
  dplyr::select(-(Grain:Stem)) %>%  
  group_by(HarvestDate, Crop, NitroTreat, WaterTreat) %>%
  summarise(nUp_mean = mean(N_uptake),nUp_sd = sd(N_uptake))

```
## Graph it
```{r,fig.width=12, fig.height=10}

a <- df_bio %>%
  mutate(Variable = "Total biomass") %>%
  mutate(MeanValue = bio_mean) %>%
  mutate(SdValue = bio_sd) %>%
  dplyr::select(-bio_mean,-bio_sd)

b <- df_n %>%
  mutate(Variable = "Nitrogen uptake") %>%
  mutate(MeanValue = nUp_mean) %>%
  mutate(SdValue = nUp_sd) %>%
  dplyr::select(-nUp_mean,-nUp_sd)

bio_N_df <- rbind(a,b)

bio_N_df %>%
  mutate(Variable = factor(Variable, levels=c("Total biomass", "Nitrogen uptake"))) %>%
  ggplot(aes(x=HarvestDate, y=MeanValue, colour = WaterTreat, 
             linetype = NitroTreat,
             shape = NitroTreat)) +
  geom_point(size=3) +
  geom_line(size=1.1) +  
  scale_shape(solid = FALSE)+
#  geom_smooth(aes(linetype=NitroTreat)) +
  geom_errorbar(aes(ymin=MeanValue-SdValue/2,
                    ymax=MeanValue+SdValue/2), width = 2) +
  facet_grid(Variable~Crop, scales="free") +
  ylab("Total N uptake (kg DM/ha)                 Total N biomass (t N/ha)") +
  theme(text = element_text(size=20))+
  theme(legend.title=element_blank()) +
  xlab("Sampling date") + 
  theme(legend.position="none")

```
# save
```{r}
write.csv(bio_N_df, "C:\\GitHubRepos\\Arbitrator\\Analysis\\Biomass_N_maizeWheat.csv")
```

