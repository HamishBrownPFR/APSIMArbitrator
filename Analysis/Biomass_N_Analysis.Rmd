---
title: "R Notebook"
output: html_notebook
---

## 1. Biomass analysis

```{r}
library(tidyr)
library (dplyr)
library (ggplot2)
library(agricolae)
library(knitr)
library(lubridate)
library(GGally)
```


# read and check
```{r}
info_raw <- 
  read.csv("C:\\GitHubRepos\\Arbitrator\\Analysis\\Biomass_N_merged_WheatMaize.csv")
info_raw$X <- NULL

summary(info_raw)

```

# check formats
```{r}
info_work <- info_raw %>%
  mutate(HarvestDate = ymd(HarvestDate)) %>%
  mutate(Plot = factor(Plot)) %>%
  mutate(Block = factor(Block)) %>%
  mutate(NitroTreat = factor(NitroTreat, 
                             levels = c("Low N","Median N","High N"))) %>%
  mutate(WaterTreat = factor(WaterTreat, 
                             levels = c("Dryland","Irrigated")))

str(info_work)
```

```{r}
summary(info_work)
```

# calculate Totals (bio and N)

```{r, fig.width=12, fig.height=8}

df_bio_sum <- info_work %>% 
#  na.omit() %>%
  dplyr::select(HarvestDate, Crop, Organ, NitroTreat, WaterTreat, Block,BiomassWeight) %>%
  tidyr::spread(Organ, BiomassWeight)  %>%
  rowwise() %>%
  mutate(Total = sum(Grain,Leaf,Rachis,Husk,Senesced, Stem, na.rm=TRUE)) %>% 
  mutate(Variable = "Biomass") %>%
  dplyr::select(Variable, HarvestDate, Crop, NitroTreat, WaterTreat, Block, Total) %>%
  mutate(Variable = as.factor(Variable))

df_N_sum <- info_work %>% 
#  na.omit() %>%
  dplyr::select(HarvestDate, Crop, Organ, NitroTreat, WaterTreat, Block,NitrogenWeight) %>%
  tidyr::spread(Organ, NitrogenWeight) %>%
  rowwise() %>%
  mutate(Total = sum(Grain,Leaf,Rachis,Husk,Senesced, Stem, na.rm=TRUE)) %>% 
  mutate(Variable = "Nitrogen") %>%
  dplyr::select(Variable, HarvestDate, Crop, NitroTreat, WaterTreat, Block, Total)

df_sum <- rbind(df_bio_sum, df_N_sum)


summary(df_sum)

```

## Do averages

```{r,fig.width=12, fig.height=10, warning=FALSE}
df_av <- df_sum %>%
  group_by(Variable, HarvestDate, Crop, NitroTreat, WaterTreat) %>%
  summarise(MeanValue = mean(Total), SdValue = sd(Total))


df_av %>%
  ggplot(aes(x=HarvestDate, y=MeanValue, colour = WaterTreat,
             linetype = NitroTreat,
             shape = NitroTreat)) +
  geom_point(size=3) +
  geom_line(size=1.1) +
  scale_shape(solid = FALSE)+
#  geom_smooth(aes(linetype=NitroTreat)) +
  geom_errorbar(aes(ymin=MeanValue-SdValue/2,
                    ymax=MeanValue+SdValue/2), width = 2) +
  facet_grid(Variable~Crop, scales="free") +
  ylab("Total N in biomass (kg DM/ha)                 Total biomass (t N/ha)") +
  theme(text = element_text(size=20))+
  theme(legend.title=element_blank()) +
  xlab("Sampling date") +
  theme(legend.position="none")+
  scale_linetype_manual(values = c("dotted", "dashed", "solid","dotted", "dashed", "solid")) 


```

